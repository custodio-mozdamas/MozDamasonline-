<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Damas Pro Master - Oficial</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --panel: #252525;
            --board-dark: #769656;
            --board-light: #eeeed2;
            --white-p: radial-gradient(circle, #ffffff 30%, #cccccc 100%);
            --black-p: radial-gradient(circle, #444444 30%, #000000 100%);
            --accent: #2ecc71;
            --danger: #e74c3c;
            --warning: #f1c40f;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #top-bar { background: #111; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; height: 50px; border-bottom: 1px solid #333; }
        #game-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px 15px; background: #222; height: 110px; }
        .hud-top { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-bottom: 2px; font-weight: bold; }
        #board-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px; position: relative; }
        #board { width: min(90vw, 450px); height: min(90vw, 450px); display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); border: 4px solid #333; position: relative; transition: transform 0.5s ease; }
        #lobby-overlay, #game-over-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .hidden { display: none !important; }
        .modal-title { font-size: 2rem; color: var(--accent); margin-bottom: 10px; }
        .square { width: 100%; height: 100%; position: relative; display: flex; justify-content: center; align-items: center; }
        .dark-sq { background-color: var(--board-dark); }
        .light-sq { background-color: var(--board-light); }
        .piece { position: absolute; width: 80%; height: 80%; border-radius: 50%; z-index: 2; box-shadow: 0 4px 4px rgba(0,0,0,0.4); pointer-events: none; transition: transform 0.3s ease; }
        .white { background: var(--white-p); border: 1px solid #999; }
        .black { background: var(--black-p); border: 1px solid #333; }
        .king::after { content: 'ðŸ‘‘'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; }
        .selected { transform: scale(1.1); outline: 4px solid #f1c40f; z-index: 10; }
        .hint { position: absolute; width: 35%; height: 35%; background: rgba(0, 255, 0, 0.4); border-radius: 50%; z-index: 1; }
        #side-menu { position: fixed; top: 0; right: -280px; width: 280px; height: 100%; background: var(--panel); box-shadow: -5px 0 15px rgba(0,0,0,0.5); transition: 0.3s; z-index: 1000; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        #side-menu.open { right: 0; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 999; }
        .timer { font-family: monospace; font-size: 1.6rem; background: #000; padding: 5px; text-align: center; border-radius: 4px; color: #444; border: 2px solid #333; }
        .timer.active { color: var(--accent); border-color: var(--accent); }
        #status-bar { grid-column: span 2; text-align: center; color: #f1c40f; font-weight: bold; font-size: 0.9rem; margin-top: 5px; }
        .menu-btn { width: 100%; padding: 10px; background: #333; border: 1px solid #444; color: white; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-start { background: var(--accent); color: black; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="overlay" onclick="window.toggleMenu()"></div>

    <div id="top-bar">
        <div id="host-name" style="font-weight: bold; color: var(--accent);">ðŸ‘‘ CARREGANDO...</div>
        <div onclick="window.toggleMenu()" style="cursor:pointer; font-size: 24px;">â‹®</div>
    </div>

    <div id="game-info">
        <div>
            <div class="hud-top"><span>PRETAS</span> <span id="count-black">12</span></div>
            <div id="timer-black" class="timer">05:00</div>
        </div>
        <div>
            <div class="hud-top"><span>BRANCAS</span> <span id="count-white">12</span></div>
            <div id="timer-white" class="timer active">05:00</div>
        </div>
        <div id="status-bar">CONECTANDO...</div>
    </div>

    <div id="board-wrapper">
        <div id="lobby-overlay">
            <h2 class="modal-title">SALA DE ESPERA</h2>
            <button class="menu-btn btn-start" onclick="window.iniciarLobby()">INICIAR PARTIDA ONLINE</button>
        </div>
        <div id="game-over-overlay" class="hidden">
            <h2 id="game-over-title" class="modal-title">FIM DE JOGO</h2>
            <button class="menu-btn btn-start" onclick="location.reload()">REINICIAR</button>
        </div>
        <div id="board"></div>
    </div>

    <div id="side-menu">
        <h3>OpÃ§Ãµes</h3>
        <button class="menu-btn" onclick="location.reload()">Reiniciar App</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCYv_oBSjS7x7hLx8p1IANOWMI5G6OmpGo",
      authDomain: "damas-pro-cf92b.firebaseapp.com",
      databaseURL: "https://damas-pro-cf92b-default-rtdb.firebaseio.com",
      projectId: "damas-pro-cf92b",
      storageBucket: "damas-pro-cf92b.firebasestorage.app",
      messagingSenderId: "606989896803",
      appId: "1:606989896803:web:63c2b940baf9f82fcf7c56"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, 'partida/atual');

    let board = [];
    let turn = 'white';
    let selectedSq = null;
    let legalMoves = [];
    let inMultiCapture = false;
    let timers = { white: 300, black: 300 };
    let gameActive = false;
    let gameStarted = false;

    // --- LÃ“GICA DO JOGO ---
    window.init = function() {
        const boardEl = document.getElementById('board');
        boardEl.innerHTML = '';
        for (let r = 0; r < 8; r++) {
            board[r] = [];
            for (let c = 0; c < 8; c++) {
                let piece = (r+c)%2===0 ? (r<3?{color:'black',king:false}:(r>4?{color:'white',king:false}:null)) : null;
                board[r][c] = piece;
                const sq = document.createElement('div');
                sq.className = `square ${(r+c)%2===0?'dark-sq':'light-sq'}`;
                sq.id = `sq-${r}-${c}`;
                sq.onclick = () => window.handleClick(r, c);
                boardEl.appendChild(sq);
            }
        }
        render();
    };

    window.handleClick = function(r, c) {
        if (!gameActive) return;
        if (board[r][c]?.color === turn && !inMultiCapture) {
            if (legalMoves.some(m => m.fr === r && m.fc === c)) selectedSq = { r, c };
        } else if (selectedSq && !board[r][c]) {
            const move = legalMoves.find(m => m.fr === selectedSq.r && m.fc === selectedSq.c && m.tr === r && m.tc === c);
            if (move) executeMove(move);
        }
        render();
    };

    function executeMove(move) {
        const p = board[move.fr][move.fc];
        board[move.tr][move.tc] = p; board[move.fr][move.fc] = null;
        if (move.victim) board[move.victim.r][move.victim.c] = null;
        
        if (!p.king && ((p.color === 'white' && move.tr === 0) || (p.color === 'black' && move.tr === 7))) p.king = true;
        turn = turn === 'white' ? 'black' : 'white';
        selectedSq = null;
        
        update(gameRef, { board, turn });
    }

    function updateLogic() {
        let moves = [];
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const p = board[r][c];
                if (p?.color === turn) {
                    const dirs = p.king ? [[1,1],[1,-1],[-1,1],[-1,-1]] : (p.color === 'white' ? [[-1,1],[-1,-1]] : [[1,1],[1,-1]]);
                    dirs.forEach(d => {
                        let nr = r + d[0], nc = c + d[1];
                        if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && !board[nr][nc]) {
                            moves.push({ fr: r, fc: c, tr: nr, tc: nc });
                        }
                    });
                }
            }
        }
        legalMoves = moves;
    }

    function render() {
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const sq = document.getElementById(`sq-${r}-${c}`);
                if(!sq) continue;
                sq.innerHTML = '';
                const p = board[r][c];
                if (p) {
                    const div = document.createElement('div');
                    div.className = `piece ${p.color} ${p.king ? 'king' : ''}`;
                    if (selectedSq?.r === r && selectedSq?.c === c) div.classList.add('selected');
                    sq.appendChild(div);
                }
                if (selectedSq && legalMoves.some(m => m.fr === selectedSq.r && m.fc === selectedSq.c && m.tr === r && m.tc === c)) {
                    sq.innerHTML = '<div class="hint"></div>';
                }
            }
        }
    }

    // --- FIREBASE SYNC ---
    window.iniciarLobby = function() {
        set(gameRef, { board, turn: 'white', gameActive: true, gameStarted: true });
    };

    onValue(gameRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            board = data.board;
            turn = data.turn;
            gameActive = data.gameActive;
            gameStarted = data.gameStarted;
            if(gameStarted) document.getElementById('lobby-overlay').classList.add('hidden');
            updateLogic();
            render();
            document.getElementById('status-bar').innerText = "CONECTADO";
            document.getElementById('status-bar').style.color = "#2ecc71";
        }
    }, (error) => {
        document.getElementById('status-bar').innerText = "ERRO DE PERMISSÃƒO (Rules)";
        document.getElementById('status-bar').style.color = "#e74c3c";
    });

    window.toggleMenu = () => {
        document.getElementById('side-menu').classList.toggle('open');
        document.getElementById('overlay').style.display = document.getElementById('side-menu').classList.contains('open') ? 'block' : 'none';
    };

    window.init(); // ForÃ§a o tabuleiro a aparecer agora
</script>
</body>
</html>
